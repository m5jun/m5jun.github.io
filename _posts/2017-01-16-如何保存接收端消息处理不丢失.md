---
layout: post
title: 如何保存接收端消息处理不丢失
description: 如何保存接收端消息处理不丢失
categories: 消息中间件
keywords: 消息中间件, 消息不丢
---


### 业务场景

在我们很多业务场景里，我们都会遇到从消息中间件中订阅消息进行处理，如何确保接受端处理消息不丢失？下面简要分析三种实现方式

### 实现策略

#### 方法一

方法一的实现策略如下图所示：

1. 应用启动时会去消息队列里读取消息；
2. 如果消息队列不为空读取到消息；
3. 将读取到的消息保存到数据库，持久化，这一步是在单独的一个事务里；
4. 执行本地事务的处理逻辑，如果成功才会更新消息的状态为成功；失败则跳过，继续下一次读取消息；
5. 注意补偿机制在图上没有表示出来，对于处理失败的消息会有一个定时任务来处理没有执行成功的消息，这样最终消息都会被成功处理；

- 缺点：会保存很多的消息，因为消息都是先落地到数据库，对业务侵入比较大；
- 优点：确保一条消息处理有问题不会阻塞后续消息的处理；

![方法1](/images/posts/mq/receive_message1.png)

#### 方法二

方法二的实现策略如下图所示：

1. 应用启动时会去数据库加载已经成功处理的消息进度；
2. 根据下个消息序列号（也就是已成功处理的消息进度加1）去消息队列里读取消息；
3. 如果消息队列不为空，执行本地事务逻辑，如果成功保存当前的消息进度；失败则继续以当前这个消息序列号去读取消息；


- 缺点：如果一条消息的消费有问题会导致其他后续消息不能被正常消费；
- 优点：数据库只有一条保存处理成功的消息进度，对业务侵入影响小、不需要补偿机制； 

![方法2](/images/posts/mq/receive_message2.png)

#### 方法三

方法三其实是对方法一和二的综合，如下所示：

1. 应用启动时会去数据库加载已经成功处理的消息进度；
2. 根据下个消息序列号（也就是已成功处理的消息进度加1）去消息队列里读取消息；
3. 如果获取到的消息不为空，执行本地事务逻辑，不管失败与否保存消息进度；但失败的同时会将消息完整保存下来，启用补偿机制进行处理；

- 缺点：实现起来比较复杂；
- 优点：一般失败的消息会比较少，所以需要保存的完整消息比较少，对业务的侵入比较小；不会阻塞后续正常的消息； 





       

 


















