---
layout: post
title: 分布式日志系统那些事儿
description: 分布式日志系统那些事儿
categories: 工具
keywords: 分布式日志系统, github, 博客
---


# 背景

在日常的业务开发中，我们系统里会打各种各样的日志，比如业务统计日志、异常监控日志、业务正常执行日志等。
那么在分布式的互联网架构里，如何处理日志问题呢？下面简要分析下分布式日志系统。

# 系统框架

常见的分布式日志系统框架如下所示：

![分布式日志系统框架图](/images/posts/log/log_frame.png.png)

上面是简要框架流程，主要包括日志采集、日志存储、日志可视化，下面会对这些进行说明。

## 日志采集

日志的采集解决的是如何将业务集群的日志采集到分布式服务器集群。

从采集方式来分来看, 主要有推和拉两种方式。

* 拉的方式优势是侵入少, 对目标机器资源占用少, 日志服务器压力可控。
* 推的方式使用最多，主要是出于安全考虑, 业务服务器不应该开放出权限让日志服务器来抓取，日志都是非常重要的业务数据。以推的方式实现实时性也更高，
但是有可能导致日志服务器压力不可控。

[日志采集工具对比点我](https://docs.google.com/spreadsheets/d/1vcL5x62vAvBLAc4OlPXjDdhSmBo5out94x0t9jVxDxI/pub?gid=0)


## 日志存储

日志存储主要分为以下几类:

* 直接存储原始日志，如存储到HDFS，然后进一步做离线分析形成更有价值的东西，如报表。
* 直接存储原始日志，如存储到搜索引擎(es)，我们可以做日志检索，非常方便为我们定位线上问题，开源之前用过ELK。
* 日志采集的时候就做实时处理, 用流式框架(storm)进行预处理, 然后存储mysql等数据库内, 供业务直接使用，如场景有广告业务中的统计点击效果计费。

## 日志可视化

这个实现方式有很多，很多大公司内部会根据自己的日志系统的特点实现可视化，如开源的有kibana等。

# 日志打印

最后说下跟我们开发人员密切相关的，在日志打印的过程中我们需要注意，不要随便打日志，
因为虽然日志极大提升了我们排查问题的效率，但是也为我们带来了性能上的损失。

我们常见的日志打印工具有log4j、logback等，这两都用得最多。两者有很多性能的对比，可以参考上网上的评价。

在处理日志时我们需要考虑以下几点：

* 不要收集你从不计划使用的日志数据，因为大量无用的日志对系统来说会损失性能。
* 有可能会用到的日志要尽可能长时间保留，有些特殊重要的日志还需要更长时间保留，需要转存。
* 日志记录应该要尽可能地详细，但是对于要报警的一定要是你必须要做出响应时才配置，否则天天大量报警只会让你麻木处理线上问题。
* 有些重要的日志可能还需要加密，不重要的日志应该定期删除。

注意：以下两种打印的实现的效果都一样，但log4j2现在可以支持{}模板，建议用模板的方式打印日志，
因为模板方式少了字符拼接的操作，性能会有很大提升，高并发场景可以用AsyncAppender异步打印。

```java
logger.error("exception occurs, id: {} , name: {}", name, id);

logger.error("exception occurs, id: " + userId + "name: " + itemId);

```
