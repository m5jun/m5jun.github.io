---
layout: post
title: MySQL事务总结
description: MySQL事务总结
categories: MySQL
keywords: MySQL, 事务, github, 博客, m5jun
---

本文所说的事务是指InnoDB存储引擎下的事务。

# 事务基础

事务是访问并更新数据库中各种数据项的一个程序执行单元。在事务中的操作，要么都做修改，要么都不做，这就是事务的目的；

## 事务的ACID特性

* 原子性：是指整个数据库事务是不可分割的工作单位。只有事务中所有的数据库操作都执行成功，才算整个事务成功。
* 一致性：指事务将数据库从一种状态转变为下一种一致的状态；
* 隔离性：要求每个读写事务的对象对其他事务的操作对象能相互分离，即该事务提交前对其他事务都不可见，通常使用锁来实现；
* 持久性：事务一旦提交，其结果就是记久性的，即使发生宕机等故障，恢复数据后，保证数据不会丢失；

# 事务的分类

## 扁平事务

* 最简单的一种类型，生产环境使用最多；
* 主要限制是不能提交或者回滚事务的某一部分，或分几步步骤提交；

## 带有保存点的扁平事务

* 除了支持扁平事务支持的操作外，允许在事务执行过程中回滚到同一事务中较早的一个状态；
* 保存点：用来通知系统应该记住事务当前的状态，以便当之后发生错误时，事务能回到保存点当时的状态；
* 保存点在事务内部是递增的；
* rollback work不影响保存点的计数，并且单调递增的编号能保持事务执行的整个历史过程，包括在执行过程中想法的改变；
* 存在问题：当发生系统崩溃时，所有的保存点都将消失，因为其保存点是易失的，而非持久的。这意味着当进行恢复时，事务需要从开始处重新执行，而不能从最近一个保存点继续执行；

## 链事务

* 定义：在提交一个事务时，释放不需要的数据对象，将必要的处理上下文隐式地传给下一个要开始的事务；
* 注意：1) 提交事务操作和开始下一个事务操作将合并为一个原子操作；2) 链事务中的回滚仅限于当前事务，即只能恢复到最近一个保存点；

## 嵌套事务

* 嵌套事务是由若干事务组成的一棵树，子树既可以是嵌套事务，也可以是扁平事务。
* 处在叶节点的事务是扁平事务。
* 位于根节点的事务称为顶层事务，其他事务称为子事务。事务的前驱称为父事务，事务的下一层称为儿子事务；
* 子事务可以提交也可以回滚。但是它的提交操作并不马上生效，除非其父事务已经提交。因此可以推断出任何子事务都在顶层事务提交后才真正的提交。
* 树中任意一个事务的回滚会引起它的所有子事务一同回滚，所以子事务仅保留A\C\I，不具有D；
* 实际的工作是交由叶子节点来完成的，即只有叶子节点的事务才能访问数据库、发送消息、获取其他类型的资源，而高层事务仅负责逻辑控制，决定何时调用相关的子事务；
* InnoDB并不原生支持嵌套事务，可以通过带有保存点的事务来模拟串行的嵌套事务；
                    
## 分布式事务

* 定义：通常是一个在分布式环境下运行的扁平事务；

# 事务的实现

事务隔离性由锁来实现；

## redo

* 主要由两部分组成：一是内存中的重做日志缓冲，其是易失的；二是重做日志文件，其是持久的；

* redo log称为重做日志用来保证事务的原子性和持久性；

* InnoDB存储引擎，其通过force log at Commit机制来实现事务的持久性，即当事务提交时，必须先将该事务的所有日志写入到重做日志文件进行持久化，待事务的COMMIT操作完成才算真正完成。
这里的日志是指重做日志，在InnoDB存储引擎中，由两部分组成，即redo log和undo log。
redo log用来保证事务的持久性，undo log用来帮助事务回滚及MVCC功能。
redo log基本都是顺序写的，在数据库运行时不需要对redo log进行读取操作。而undo log是需要随机读写的。

* 重做日志块的大小是512字节；重做日志文件是以块的方式进行保存的；

* 二进制日志(binlog)：主要是用来POINT_IN_TIME(PIT）的恢复及主从复制。

* redo与binlog的区别：

    1）重做日志是在Innodb存储引擎层产生，而二进制日志是在MySQL数据库上层产生的；
    
    2）记录的内容形式不同，一个记录的是对应的SQL语句，一个记录的是物理格式的日志，其记录的是对于每个页的修改；
    
    3）写入时间点不同，二进制日志只在事务提交完成后进行一次写入，重做日志在事务进行中不断写入；
    
                 
## undo

* undo log用来保证事务的一致性；
* 事务的回滚操作需要undo;
* undo存放在数据库内部的一个特殊段中，这个段称为undo段；
* undo是逻辑日志，因此只是将数据库逻辑地恢复到原来的样子，而非物理；
* InnoDB存储引擎回滚时，它实际上做的是与先前相反的工作；
* undo的另一个作用是MVCC；当用户读取一行记录时，若该记录已经被其他事务占用，当前事务可以通过undo读取之前的行版本信息；
* undo log会产生redo log，也就是undo log的产生会伴随着redo log的产生，这是因为undo log也需要持久性的保护；

* undo与redo的区别：

    1）两者记录的内容不同，redo通常是物理日志，记录的是页的物理修改操作，undo是逻辑日志，根据每行进行记录；
    
    2）undo和redo的作用可以视为是一种恢复操作，redo恢复提交事务修改的页操作，而undo回滚行记录到某个特定版本；


TRUNCATE TABLE语句是DDL，因此虽然和对整张表DELETE的结果一样，但这是不能被回滚的；

计算TPS: (com_commit + com_rollback) / time; 注意隐式提交和回滚的不会计算到这个变量中；
    
## 分布式事务

指的是允许多个独立的事务资源参与到一个全局事务中。

### 提交方式

分布式事务使用两段式提交的方式。

* 在第一阶段，所有参与全局事务的节点都开始准备（PREPARE)，告诉事务管理器它们准备好提交了。
* 在第二阶段，事务管理器告诉资源管理器执行COMMIT还是ROLLBACK。
* 如果任何一个节点显示不能提交，则所有的节点被告知需要回滚。

### XA事务组成

![XA事务](/images/posts/mysql/xa.png)

* 事务管理器=MySQL客户端：协调参与全局事务中的各个事务。需要和参与全局事务的所有资源管理进行通信；
* 资源管理器=MySQL DB：提供访问事务资源的方法。通常一个数据库就是一个资源管理器；
* 应用程序：定义事务边界，指定全局事务的操作；
                      
# 事务优化方式

* 避免在循环中提交事务；
* 长事务分解成小事务，避免事务回滚代价太大；
           