---
layout: post
title: 金融系统设计规范
description: 金融系统设计规范
categories: 系统设计
keywords: 系统设计, 金融系统, 规范, github, 博客, m5jun
---

互联网金融系统对系统设计要求上非常严谨，当系统出现问题时很容易引发资损问题。
为了规避潜在的风险，这就要求我们在前期系统设计上做好充分考虑，现总结一些好的设计规范，提高我们的风险意识。


## 对外服务接口
对外服务接口一般主要是对其他系统提供的RPC或HTTP服务接口，在提供这些服务接口时我们应该要考虑以下几点：
* 接口服务功能描述简洁清晰。
* 如果接口参数中有金额，一定要明确单位是元或分，如果有精度保留小数的也要说明，否则使用不当容易引发资损问题。
* 请求参数中的幂等字段要说明含义，当发生幂等情况时需要说明返回结果。
* 对于可能抛出的异常、异常如何处理、错误码要详细说明。
* 对类似范围这种量比较大的查询需要限制一次查询的条数，防止超时的情况发生。
* 对大批次的操作需要描述性能、处理极限能力。同时服务端要有限流、熔断等措施。
* 服务接口需要设置超时时间。


## 幂等规范
幂等在重要性在金融系统设计要时时考虑的，因为很多资损问题基本都是由幂等控制不好导致的。

* 幂等的控制在服务端接口需要明确约定根据哪些字段做幂等控制，并且详细说明如果控制幂等，当发生幂等时返回的错误码也要明确说明。

* 幂等被服务端检测到后，还需要做二次幂等判断，
例如调用第二次请求的requestId与第一次一样时，我们不能简单地做幂等返回处理，还需要对请求参数进行校验，必须与第一次的请求参数一样，这样我们才能确定这是一次重复的请求。

* 对于数据变更操作如插入、修改，需要通过幂等机制来防止多个并发请求导致资损问题。

* 对消息的处理要注意，因为消息有可能是乱序重发，需要在业务处理时加锁并且根据业务状态来判断消息是否过期，是否需要再次处理。
对于消息驱动的业务流处理，先同步调用再异步接受消息处理，两者的时序不一定是先同步后异步接受到消息，在处理的时候要注意。

## 锁操作规范
* 对共享数据的操作需要保证原子性，通过加锁或数据库锁的方式实现。
* 数据库单笔操作，一锁、二判断、三更新。
* 尽量减少数据库锁的数量。
* 避免死锁问题，加锁时以顺序加锁保证。对于select for update 应该加no wait。
* 乐观锁可以考虑在控制表新增version字段，每次变更比较并＋1，使得具备统一模式的并发控制。那种只通过update加where条件来实现的场景有限，比如扣库存。
* 对于update操作需要检查更新操作返回的纪录条数是否正确。

## 其他规范
* 比较敏感的信息如身份证，银行卡号等需要脱敏展示。
* 资金业务服务需要具备降级、熔断的能力。
* 灰度变更的能力（白名单或灰用户id维度实现）。
* 对于一些后台功能的资金相关的操作一定要有权限控制，且有可能还需要多级人员审批。
* 需要关注新业务变更监控是否生效，是否会导致原监控点失效等。
* 资金类业务必须要有上下游数据核对，根据业务特点做到T+0/T+H/T+1等。

